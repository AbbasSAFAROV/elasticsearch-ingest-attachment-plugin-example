<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Attachments Demo</title>
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
  <link rel="stylesheet" href="bower_components/fontawesome/css/font-awesome.css" />
  <style>
    html, body {
    height: 100vh;
    }

    mark {
    background: yellow;
    }

    .drop:after {
      content: 'Drop files here';
    pointer-events: none;
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    background-color: #999;
    background-image: radial-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,1) 100%);
    opacity: .5;
    color: white;
    line-height: 100vh;
    text-align: center;
    font-size: 10vh;
    text-transform: uppercase;
    text-shadow: 1px 1px 5px #000;
    }
  </style>
</head>
<body>
<div class="container" style="padding: 15px">
  <form class="row" data-bind="submit: reload">
    <p class="col-md-10">
      <input type="search" class="form-control" data-bind="value: q" />
    </p>
    <p class="col-md-2">
      <button class="btn btn-default btn-block" data-bind="click: reload">Filter</button>
    </p>
  </form>

  <ul class="list-group" data-bind="foreach: hits">
    <li class="list-group-item">
      <div class="media">
        <div class="media-body">
          <i data-bind="css: icon"></i>
          <strong data-bind="text: fields['policy.name']"></strong>
        </div>
        <div class="media-right">
          Score:<strong data-bind="text: _score"></strong>
        </div>
        <div class="media-right">
          <a class="text-danger" href="#" data-bind="click: $root.delete" title="delete"><span class="fa fa-remove"></span></a>
        </div>
      </div>
      <div data-bind="if: hasHighlights">
        <ol data-bind="foreach: highlight['policy.content']">
          <li data-bind="html: $data"></li>
        </ol>
      </div>
    </li>
  </ul>
</div>
<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
<script src="bower_components/knockout/dist/knockout.debug.js"></script>
<script src="bower_components/elasticsearch/elasticsearch.js"></script>
<script>
        function Hit(data) {
            var self = this;

            ko.utils.extend(self, data);

            self.hasHighlights = self.highlight && self.highlight["policy.content"] && self.highlight["policy.content"].length > 0;

            if(self.fields["policy.content_type"][0] === 'application/msword' || self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.wordprocessingml.template' || self.fields["policy.content_type"][0] === 'application/vnd.ms-word.document.macroEnabled.12' || self.fields["policy.content_type"][0] === 'application/vnd.ms-word.template.macroEnabled.12') {
                self.icon = 'fa fa-file-word-o';
            } else if(self.fields["policy.content_type"][0] === 'audio/basic') {
                self.icon = 'fa fa-file-audio-o';
            } else if(self.fields["policy.content_type"][0] === 'video/msvideo' || self.fields["policy.content_type"][0] === 'video/avi' || self.fields["policy.content_type"][0] === 'video/x-msvideo') {
                self.icon = 'fa-file-video-o';
            } else if(self.fields["policy.content_type"][0] === 'image/bmp' || self.fields["policy.content_type"][0] === 'image/gif' || self.fields["policy.content_type"][0] === 'image/jpeg' || self.fields["policy.content_type"][0] === 'image/png' || self.fields["policy.content_type"][0] === 'image/svg+xml' || self.fields["policy.content_type"][0] === 'image/tiff') {
                self.icon = 'fa-file-image-o';
            } else if(self.fields["policy.content_type"][0] === 'application/pdf') {
                self.icon = 'fa fa-file-pdf-o';
            } else if(self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.presentationml.template' || self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.presentationml.slideshow' || self.fields["policy.content_type"][0] === 'application/vnd.ms-powerpoint' || self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.presentationml.presentation') {
                self.icon = 'fa fa-file-powerpoint-o';
            } else if(self.fields["policy.content_type"][0] === 'application/vnd.ms-excel' || self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || self.fields["policy.content_type"][0] === 'application/vnd.openxmlformats-officedocument.spreadsheetml.template' || self.fields["policy.content_type"][0] === 'application/vnd.ms-excel.sheet.macroEnabled.12' || self.fields["policy.content_type"][0] === 'application/vnd.ms-excel.template.macroEnabled.12' || self.fields["policy.content_type"][0] === 'application/vnd.ms-excel.addin.macroEnabled.12' || self.fields["policy.content_type"][0] === 'application/vnd.ms-excel.sheet.binary.macroEnabled.12') {
                self.icon = 'fa fa-file-excel-o';
            } else {
                self.icon = 'fa fa-file-text-o';
            }
        }

        function Model() {
            var self = this;

            self.index = 'policies';
            self.type = 'risk'; // need to be replaced in mapping also

            self.client = new elasticsearch.Client({
                hosts: [
                  'http://admin:password@localhost:9200'
                ],
                log: 'trace'
            });

            self.client.ping({
              requestTimeout: 30000,  // undocumented params are appended to the query string
              hello: "elasticsearch"
            }, function (error) {
              if (error) {
                console.log('Could not connect to ElasticSearch cluster!');
              } else {
                console.log('Connected to ElasticSearch cluster!');
              }
            });

            self.q = ko.observable('');
            self.hits = ko.observableArray();

            self.reload = function() {
                var body = {
                    index: self.index,
                    type: self.type,
                    body: {
                        fields: [ 'policy.content_type', 'policy.author', 'policy.name', 'policy.title', 'policy.content_length', 'policy.date', 'policy.language', 'policy.keywords' ]
                    }
                };

                if(self.q() && self.q().trim().length > 0) {
                    body.body.query = {
                            match: {
                                'policy.content': self.q()
                            }
                    };

                    body.body.highlight = {
                        tag_schema: 'styled',
                        fields: {
                          'policy.content': {
                            pre_tags : ['<mark>'],
                            post_tags : ['</mark>'],
                            fragment_size: 100,
                            number_of_fragments: 10,
                            order: 'score'
                          }
                        }
                    };
                }

                self.client.search(body).then(function(body){
                    self.hits(body.hits.hits.map(function(hit){ return new Hit(hit); }));
                }, alert);
            }

            self.delete = function(data) {
                self.client.delete({
                    index: self.index,
                    type: self.type,
                    id: data._id,
                    ignore: [404]
                }, function(err, body){
                    if(body.found) {
                        self.hits.remove(data);
                    }
                });
            };

            function nop(event) {
                event.stopPropagation();
                event.preventDefault();
                event.dataTransfer.dropEffect = 'copy';
                document.body.className = event.type === 'dragleave' ? '' : 'drop';
            }
            document.body.addEventListener('dragenter', nop);
            document.body.addEventListener('dragover', nop, false);
            document.body.addEventListener('dragleave', nop);
            document.body.addEventListener('drop', function(event) {
                event.stopPropagation();
                event.preventDefault();

                [].forEach.call(event.dataTransfer.files, function(file){
                    var reader = new FileReader();
                    reader.addEventListener('load', function(event){
                        self.client.create({
                            index: self.index,
                            type: self.type,
                            body: {
                                isEnabled: true,
                                policy: {
                                    _indexed_chars: -1,
                                    _content: event.target.result.substr(event.target.result.indexOf(',') + 1),
                                    _name: file.name,
                                    _content_type: file.type,
                                    _date: (new Date(file.lastModified)).toISOString()
                                }
                            }
                        }).then(function(body){
                            body.fields = {
                                'policy.name': file.name,
                                'policy.date': (new Date(file.lastModified)).toISOString(),
                                'policy.content_type': file.type
                            };
                            self.hits.push(new Hit(body));
                        });
                    });
                    reader.readAsDataURL(file);
                    document.body.className = '';
                });

            }, false);


            self.mappings = {
                index: self.index,
                body: {
                    mappings: {}
                }
            };

            self.mappings.body.mappings[self.type] = {
                properties: {
                  isEnabled: {type: 'boolean'},
                  policy: {
                    type: 'attachment',
                    fields: {
                      author: { store : true },
                      content_length: { store : true },
                      date: { store : true },
                      language: { store : true },
                      name: { store : true },
                      title: { store : true },
                      keywords: { store : true },
                      content_type: { store: true },
                      content: {
                        type: 'string',
                        analyzer: 'english',
                        term_vector: 'with_positions_offsets',
                        store: true
                      }
                    }
                  }
                }
            };

            self.client.indices.exists({index: self.index}, function(body, exists){
                if(!exists) {
                    self.client.indices.create(self.mappings);
                } else {
                    self.reload();
                }
            });
        }

        var model = new Model();
        ko.applyBindings(model);
    </script>
</body>
</html>